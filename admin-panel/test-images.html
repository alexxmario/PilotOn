<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel Local Images Test - PilotOn</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .product { 
            border: 1px solid #ddd; 
            margin: 20px 0; 
            padding: 20px; 
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .product-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        .product-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #eee;
        }
        .product-info h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .product-images {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .error { color: #d32f2f; }
        .success { color: #2e7d32; }
        .status {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .status.loading { background: #e3f2fd; }
        .status.success { background: #e8f5e8; color: #2e7d32; }
        .status.error { background: #ffebee; color: #d32f2f; }
        .test-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Admin Panel Local Images Test</h1>
        
        <div class="test-info">
            <h3>Test Configuration:</h3>
            <ul>
                <li><strong>Backend API:</strong> http://localhost:5001/api</li>
                <li><strong>Image Server:</strong> http://localhost:5001/images/products/</li>
                <li><strong>Expected:</strong> Local images should load with full URLs</li>
            </ul>
        </div>
        
        <div id="results">Loading...</div>
    </div>

    <script>
        async function testAdminPanelImages() {
            const resultsDiv = document.getElementById('results');
            
            try {
                // Simulate the dataProvider logic
                const baseUrl = 'http://localhost:5001';
                
                const convertImageUrls = (item) => {
                    if (item.images && Array.isArray(item.images)) {
                        item.images = item.images.map(image => ({
                            ...image,
                            url: image.url.startsWith('http') ? image.url : `${baseUrl}${image.url}`
                        }));
                    }
                    return item;
                };
                
                // Fetch products from API
                const response = await fetch('http://localhost:5001/api/products?limit=3');
                const data = await response.json();
                
                if (!data.products || data.products.length === 0) {
                    resultsDiv.innerHTML = '<p class="error">‚ùå No products found!</p>';
                    return;
                }
                
                resultsDiv.innerHTML = '<h2>üéØ Testing Admin Panel Image Integration:</h2>';
                
                let testCount = 0;
                let successCount = 0;
                
                for (const product of data.products.slice(0, 3)) {
                    // Apply the same conversion logic as admin panel dataProvider
                    const convertedProduct = convertImageUrls({...product, id: product._id});
                    
                    const productDiv = document.createElement('div');
                    productDiv.className = 'product';
                    
                    let html = `
                        <div class="product-header">
                            <div style="flex-shrink: 0;">
                    `;
                    
                    if (convertedProduct.images && convertedProduct.images.length > 0) {
                        const primaryImage = convertedProduct.images.find(img => img.isPrimary) || convertedProduct.images[0];
                        html += `
                            <img 
                                class="product-image" 
                                src="${primaryImage.url}" 
                                alt="${primaryImage.alt || convertedProduct.name}"
                                onload="updateStatus(this, 'success', '‚úÖ Loaded')"
                                onerror="updateStatus(this, 'error', '‚ùå Failed')"
                            />
                            <span class="status loading">üîÑ Loading...</span>
                        `;
                        testCount++;
                    } else {
                        html += `<div class="product-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999;">No Image</div>`;
                    }
                    
                    html += `
                            </div>
                            <div class="product-info">
                                <h3>${convertedProduct.name}</h3>
                                <p><strong>SKU:</strong> ${convertedProduct.sku}</p>
                                <p><strong>Price:</strong> ${convertedProduct.price} RON</p>
                                <p><strong>Brand:</strong> ${convertedProduct.brand}</p>
                                <p><strong>Primary Image URL:</strong> <br/>
                                   <code style="font-size: 0.9em; background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">
                                     ${convertedProduct.images?.[0]?.url || 'No image URL'}
                                   </code>
                                </p>
                            </div>
                        </div>
                    `;
                    
                    // Show all thumbnails
                    if (convertedProduct.images && convertedProduct.images.length > 1) {
                        html += '<div><strong>All Images:</strong></div><div class="product-images">';
                        convertedProduct.images.forEach((image, index) => {
                            html += `
                                <img 
                                    class="thumbnail" 
                                    src="${image.url}" 
                                    alt="${image.alt || `Image ${index + 1}`}"
                                    onload="this.style.border='2px solid #4caf50'"
                                    onerror="this.style.border='2px solid #f44336'"
                                    title="${image.url}"
                                />
                            `;
                            testCount++;
                        });
                        html += '</div>';
                    }
                    
                    productDiv.innerHTML = html;
                    resultsDiv.appendChild(productDiv);
                }
                
                // Add summary
                setTimeout(() => {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'test-info';
                    summaryDiv.innerHTML = `
                        <h3>üìä Test Summary:</h3>
                        <p><strong>Images Tested:</strong> ${testCount}</p>
                        <p><strong>Expected Behavior:</strong> All images should load from http://localhost:5001/images/products/</p>
                        <p><strong>Status:</strong> Check for green borders (‚úÖ success) vs red borders (‚ùå failed)</p>
                    `;
                    resultsDiv.appendChild(summaryDiv);
                }, 2000);
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                console.error('Test error:', error);
            }
        }
        
        function updateStatus(img, type, message) {
            const statusSpan = img.nextElementSibling;
            if (statusSpan && statusSpan.classList.contains('status')) {
                statusSpan.className = `status ${type}`;
                statusSpan.textContent = message;
            }
        }
        
        // Run test when page loads
        testAdminPanelImages();
    </script>
</body>
</html>